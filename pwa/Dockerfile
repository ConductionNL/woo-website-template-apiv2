FROM node:18 AS builder
# Set working directory
WORKDIR /app

COPY package.json package-lock.json ./

# Copy all files from current directory to working dir in image
# install node modules and build assets
RUN npm install

RUN npm install @parcel/watcher

COPY . .

# Build-time configuration for Gatsby (used at build, not runtime)
ARG GATSBY_ENV_VARS_SET=true
ARG GATSBY_API_BASE_URL
ARG GATSBY_DEV_ENVIRONMENT=false
ARG GATSBY_NL_DESIGN_THEME_CLASSNAME
ARG GATSBY_CSP_CONNECT_SRC_FULL
ARG GATSBY_CSP_CONNECT_SRC_EXTRA
ARG GATSBY_SHOW_THEME_SWITCHER
ARG GATSBY_FAVICON_URL
ARG GATSBY_ORGANISATION_NAME
ARG GATSBY_JUMBOTRON_IMAGE_URL
ARG GATSBY_FOOTER_LOGO_URL
ARG GATSBY_FOOTER_LOGO_HREF
ARG GATSBY_FOOTER_CONTENT
ARG GATSBY_FOOTER_CONTENT_HEADER
ARG GATSBY_OIDN_NUMBER
ARG GATSBY_SHOW_CATEGORY
ARG GATSBY_SHOW_ORGANIZATION
ARG GATSBY_ANALYTICS_URL
ARG GATSBY_DATE_FULL_MONTH
ENV GATSBY_ENV_VARS_SET=$GATSBY_ENV_VARS_SET
ENV GATSBY_API_BASE_URL=$GATSBY_API_BASE_URL
ENV GATSBY_DEV_ENVIRONMENT=$GATSBY_DEV_ENVIRONMENT
ENV GATSBY_NL_DESIGN_THEME_CLASSNAME=$GATSBY_NL_DESIGN_THEME_CLASSNAME
ENV GATSBY_CSP_CONNECT_SRC_FULL=$GATSBY_CSP_CONNECT_SRC_FULL
ENV GATSBY_CSP_CONNECT_SRC_EXTRA=$GATSBY_CSP_CONNECT_SRC_EXTRA
ENV GATSBY_SHOW_THEME_SWITCHER=$GATSBY_SHOW_THEME_SWITCHER
ENV GATSBY_FAVICON_URL=$GATSBY_FAVICON_URL
ENV GATSBY_ORGANISATION_NAME=$GATSBY_ORGANISATION_NAME
ENV GATSBY_JUMBOTRON_IMAGE_URL=$GATSBY_JUMBOTRON_IMAGE_URL
ENV GATSBY_FOOTER_LOGO_URL=$GATSBY_FOOTER_LOGO_URL
ENV GATSBY_FOOTER_LOGO_HREF=$GATSBY_FOOTER_LOGO_HREF
ENV GATSBY_FOOTER_CONTENT=$GATSBY_FOOTER_CONTENT
ENV GATSBY_FOOTER_CONTENT_HEADER=$GATSBY_FOOTER_CONTENT_HEADER
ENV GATSBY_OIDN_NUMBER=$GATSBY_OIDN_NUMBER
ENV GATSBY_SHOW_CATEGORY=$GATSBY_SHOW_CATEGORY
ENV GATSBY_SHOW_ORGANIZATION=$GATSBY_SHOW_ORGANIZATION
ENV GATSBY_ANALYTICS_URL=$GATSBY_ANALYTICS_URL
ENV GATSBY_DATE_FULL_MONTH=$GATSBY_DATE_FULL_MONTH
ENV NODE_ENV=production

RUN npm run build

FROM nginx
COPY --from=builder /app/public /usr/share/nginx/html

RUN chown -R nginx:nginx /usr/share/nginx && chmod -R 755 /usr/share/nginx && \
        chown -R nginx:nginx /var/cache/nginx && \
        chown -R nginx:nginx /var/log/nginx && \
        chown -R nginx:nginx /etc/nginx/conf.d
RUN touch /var/run/nginx.pid && \
        chown -R nginx:nginx /var/run/nginx.pid

COPY docker/nginx.conf /etc/nginx/nginx.conf
COPY docker/default.conf.template /etc/nginx/templates/default.conf.template
COPY docker/entrypoint.d/30-generate-runtime.sh /docker-entrypoint.d/30-generate-runtime.sh
COPY docker/runtime.json.template /docker-runtime-templates/runtime.json.template
ENV NGINX_ENVSUBST_OUTPUT_DIR=/etc/nginx/conf.d
ENV NGINX_ENVSUBST_TEMPLATE_DIR=/etc/nginx/templates
ENTRYPOINT ["/docker-entrypoint.sh"]
CMD ["nginx", "-g", "daemon off;"]
USER nginx
EXPOSE 8080
